name: Deploy to Railway

on:
  push:
    branches:
      - main        # Production environment
      - test        # Test environment

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ›ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ¯ Determine environment and service
        id: env
        run: |
          if [[ ${{ github.ref }} == 'refs/heads/main' ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "service_id=00f8b475-07df-4527-a780-01736f994edd" >> $GITHUB_OUTPUT
            echo "display_name=ğŸ­ PRODUCTION" >> $GITHUB_OUTPUT
          elif [[ ${{ github.ref }} == 'refs/heads/test' ]]; then
            echo "environment=test" >> $GITHUB_OUTPUT
            echo "service_id=466df4c3-48c1-4b14-adce-6c3a76c56314" >> $GITHUB_OUTPUT
            echo "display_name=ğŸ§ª TEST" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ” Load Railway token from 1Password
        uses: 1password/load-secrets-action@v1
        with:
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          RAILWAY_TOKEN: "op://Programing/Railway Deploy/Token"

      - name: ğŸš‚ Install Railway CLI
        run: |
          curl -L https://railway.app/install.sh | sh
          echo "$HOME/.railway/bin" >> $GITHUB_PATH

      - name: ğŸ“¥ Install 1Password CLI
        run: |
          curl -sS https://downloads.1password.com/linux/keys/1password.asc | sudo gpg --dearmor --output /usr/share/keyrings/1password-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/$(dpkg --print-architecture) stable main" | sudo tee /etc/apt/sources.list.d/1password.list
          sudo apt update && sudo apt install -y 1password-cli

      - name: ğŸ”— Connect Railway to project
        run: |
          echo "Reading Project ID from 1Password..."
          PROJECT_ID=$(op read "op://Programing/Railway Deploy/Project ID")
          echo "Authenticating with Railway..."
          railway login --token $RAILWAY_TOKEN
          echo "Connecting to Railway project..."
          railway link --project $PROJECT_ID
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}

      - name: ğŸš€ Deploy to Railway (${{ steps.env.outputs.display_name }})
        run: railway up --service=${{ steps.env.outputs.service_id }}

      - name: âœ… Deployment Status
        run: |
          echo "ğŸ‰ Successfully deployed to ${{ steps.env.outputs.display_name }}"
          echo "ğŸš‚ Railway service: ${{ steps.env.outputs.service_id }}"
          echo "ğŸŒ Environment: ${{ steps.env.outputs.environment }}"
          
          if [[ "${{ steps.env.outputs.environment }}" == "test" ]]; then
            echo "ğŸ”— Test URL: https://nestjs-stripe-notion-automation-test.up.railway.app"
          elif [[ "${{ steps.env.outputs.environment }}" == "production" ]]; then
            echo "ğŸ”— Production URL: https://nestjs-stripe-notion-automation-prod.up.railway.app"
          fi 